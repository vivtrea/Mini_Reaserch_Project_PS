---
title: "Interim project"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

Members: Daryna Horetska, Yaryna Pechenenko, Andrii Hovorov Our dataset: Multi-Resistance Antibiotic Susceptibility <https://www.kaggle.com/datasets/adilimadeddinehosni/multi-resistance-antibiotic-susceptibility> Our goal: to analyse bacteria resistance to different antibiotic depending on age, previous diseases, gender and etc.

Cleaning data: - replace unknown data by NA, clean it - separate age and gender - extract clean (w/o ID) bacteria name - unified each name of bacteria and states of resistance

```{r}
library(tidyr)
library(dplyr)
library(stringr)
library(DescTools)
library(ggplot2)


dataset_readed <- read.csv("Bacteria_dataset_Multiresictance.csv")

dataset_readed[dataset_readed == "?"] <- NA
dataset_readed[dataset_readed == "missing"] <- NA
dataset_readed[dataset_readed == "unknown"] <- NA
dataset_readed[dataset_readed == "error"] <- NA
dataset_readed[dataset_readed == "???"] <- NA
dataset_readed[dataset_readed == "??"] <- NA
dataset_readed[dataset_readed == ""] <- NA
dataset_readed[dataset_readed == "None"] <- NA
dataset_readed[dataset_readed == "null"] <- NA
dataset_readed <- dataset_readed %>% 
  separate(Souches, into = c("Strain_ID", "souche_description"), sep = " ", extra = "merge", fill = "right")
dataset_readed$souche_description <- tolower(dataset_readed$souche_description)
dataset_readed$souche_description <- trimws(dataset_readed$souche_description)

# Escherichia coli
dataset_readed$souche_description[dataset_readed$souche_description == "e.coi" | dataset_readed$souche_description == "e coli" | dataset_readed$souche_description == "e.cli" | dataset_readed$souche_description == "e. coli"] <- "escherichia coli"

# Enterobacteria spp.
dataset_readed$souche_description[dataset_readed$souche_description == "spp. enteobacteria spp."] <- "enterobacteria spp."
dataset_readed$souche_description[dataset_readed$souche_description == "enter.bacteria" | dataset_readed$souche_description == "enteobacteria spp." | dataset_readed$souche_description == "enter.bacteria spp."] <- "enterobacteria spp."

# Klebsiella pneumoniae
dataset_readed$souche_description[dataset_readed$souche_description == "klbsiella pneumoniae" |dataset_readed$souche_description == "klebsie.lla pneumoniae"] <- "klebsiella pneumoniae"

# Proteus mirabilis
dataset_readed$souche_description[dataset_readed$souche_description == "protus mirabilis" | dataset_readed$souche_description == "prot.eus mirabilis" | dataset_readed$souche_description == "proeus mirabilis"] <- "proteus mirabilis"

antibiotics <- c("AMX.AMP", "AMC", "CZ", "FOX", "CTX.CRO", "IPM", "GEN", "AN", "Acide.nalidixique", "ofx", "CIP", "C", "Co.trimoxazole", "Furanes", "colistine")

dataset_readed <- na.omit(dataset_readed)

dataset_readed[antibiotics] <- lapply(dataset_readed[antibiotics], function(x) {
  x[x == "r"] <- "R"
  x[x == "intermediate"] <- "R"
  x[x == "Intermediate"] <- "R"
  x[x == "i"] <- "R"
  x[x == "s"] <- "S"
  x
})

dataset_readed <- dataset_readed %>%
  separate(`age.gender`, into = c("age", "gender"), sep = "/", remove = FALSE)
```

```{r}
dataset_readed$age <- as.numeric(dataset_readed$age)

cat("Descriptive analysis of ages\n")
summary(dataset_readed$age)
cat("Infection frequency")
table(dataset_readed$Infection_Freq)

```

We have 9 different types of bacteria

```{r}
n_distinct(dataset_readed$souche_description)
```

There are frequency of each bacteria we have:

```{r}
dataset_readed %>%
  count(souche_description, sort = TRUE) %>%
  ggplot(aes(x = reorder(souche_description, n), y = n)) +
  geom_col() +
  coord_flip() +
  labs(title = "Frequency of Bacteria Species",
    x = "Bacteria",
    y = "Amount") + theme_minimal()
```

Hypothesis: First of all we investigated age distribution

```{r}
age <- dataset_readed$age
hist(age,breaks = seq(min(age,na.rm = TRUE), max(age, na.rm = TRUE), by = 2), 
     col = "skyblue",
     border = "white",
     main = "Distribution of patient ages",
     xlab = "Age",
     ylab = "Number of patients")

```

Due to small p-value (2.2e-16 \< 0.05) we should reject $H_0$ (age distribution is normal) -\> so we won't use t-test for further hypothesis.

```{r}
ks.test(age, "pnorm", alternative="two.sided",mean = mean(age), sd=sd(age))
```

```{r}
plot(ecdf(age), col="cyan", pch=19, cex=0.7)
age_range <- seq(min(age), max(age), length.out = 500)
lines(age_range,
      pnorm(age_range, mean(age), sd=sd(age)), 
      col = "magenta",
      pch = 19,
      lwd = 2)
```

1.  $H_0$: The mean age of patients with a resistant infection is equal to the mean age of patients with a susceptible infection $H_1$: The mean age of patients with resistant infection is not equal to those with a susceptible infection

Because our age is not normally distributed we use Mann-Whitney U test.

We divided patients into 2 groups: resistant (when patient is resistant to \> 5 types of antibiotics) and susceptible otherwise

```{r}
abx_data <- dataset_readed[, antibiotics]
dataset_readed$R_count <- rowSums(abx_data == "R", na.rm = TRUE)
dataset_readed$Resistance_Status <- ifelse(dataset_readed$R_count > 5, 'Resistant', 'Susceptible')
group_r <- dataset_readed$age[dataset_readed$Resistance_Status == 'Resistant']
group_s <- dataset_readed$age[dataset_readed$Resistance_Status == 'Susceptible']

```

```{r}
ks.test(group_r, "pnorm", alternative="two.sided",mean = mean(group_r), sd=sd(group_r))
```

```{r}
plot(ecdf(group_r), col="cyan", pch=19, cex=0.7)
gr_range <- seq(min(group_r), max(group_r), length.out = 500)
lines(age_range,
      pnorm(gr_range, mean(group_r), sd=sd(group_r)), 
      col = "magenta",
      pch = 19,
      lwd = 2)
```

```{r}
ks.test(group_s, "pnorm", alternative="two.sided",mean = mean(group_s), sd=sd(group_s))
```

```{r}
plot(ecdf(group_s), col="cyan", pch=19, cex=0.7)
gs_range <- seq(min(group_s), max(group_s), length.out = 500)
lines(gs_range,
      pnorm(gs_range, mean(group_s), sd=sd(group_s)), 
      col = "magenta",
      pch = 19,
      lwd = 2)
```

```{r}
wilcox.test(group_r, group_s, alternative = "two.sided")
```

2.  

$H_0$: diabetes has no impact on resistance to antibiotic $H_1$: diabetes has impact on resistance to antibiotic

```{r}

diabetic_r <- dataset_readed$ID[dataset_readed$Resistance_Status == 'Resistant'& dataset_readed$Diabetes == "True" ]
diabetic_s <- dataset_readed$ID[dataset_readed$Resistance_Status == 'Susceptible' & dataset_readed$Diabetes == "True" ]

nondiabetic_r <- dataset_readed$ID[dataset_readed$Resistance_Status == 'Resistant'& dataset_readed$Diabetes == "No" ]
nondiabetic_s <-  dataset_readed$ID[dataset_readed$Resistance_Status == 'Susceptible'& dataset_readed$Diabetes == "No" ]
```

```{r}

contingency_table <- table(dataset_readed$Diabetes, dataset_readed$Resistance_Status)

contingency_table <- addmargins(contingency_table)

print(contingency_table)
```

```{r}
chisq.test(contingency_table)
```

3.  Continue to the previous $H_0$: the effect of diabetes on resistance does not depend on the type of bacteria $H_1$: the effect of diabetes on resistance does depend on the type of bacteria

```{r}
#install.packages("DescTools")
```

```{r}
top3_bacteria <- c("escherichia coli", "enterobacteria spp.", "proteus mirabilis")
data_top3 <- dataset_readed[dataset_readed$souche_description %in% top3_bacteria & !is.na(dataset_readed$Diabetes), ]

table_3way <- table(data_top3$Diabetes, data_top3$Resistance_Status, data_top3$souche_description)

#Breslow-Day test (tests for homogeneity of odds ratios across strata)
BreslowDayTest(table_3way)
```
