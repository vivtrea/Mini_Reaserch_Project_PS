---
title: "Mini-Research Project"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

# Antibiotic Resistance Patterns

### Team members: Daryna Horetska, Yaryna Pechenenko, Andrii Hovorov

**Dataset**: Multi-Resistance Antibiotic Susceptibility

10 710 records that contains bacterial isolates, associated risk factors, and antibiotic susceptibility results per patient.

<https://www.kaggle.com/datasets/adilimadeddinehosni/multi-resistance-antibiotic-susceptibility>

**Our goal**: to analyse bacteria resistance to different antibiotic depending on age, previous diseases, gender etc.

## Data description

#### Bacteria Sample Identifiers

-   ID
-   Souche (Strain) â€“ bacteria name

#### Patient Demographics

-   Age (numeric)
-   Gender (encoded as M or F)
-   Location (US state, district etc.)

#### Clinical Risk Factors

-   Diabetes
-   Hypertension
-   Prior hospitalization (within the last 6 months)
-   Frequency of recurrent infections

#### Infection Information

-   Specific bacterial infection identifying the illness
-   Antibiotic Susceptibility Test Results

Scope: Tested against 15 antibiotics (grouped by antibiotic family)

Result Values: Resistant, Susceptible, Intermediate, or Missing data

#### Metadata

-   Date of sample collection
-   Free-text comments (in various languages)

All the data is raw and dirty, therefore needs data cleaning before conduction of any analysis.

### Set up necessary libraries

First, let us set up all the necessary libraries for our research in purpose of data visualization, descriptive analysis, text cleaning, separating columns, providing Breslow-Day test.

```{r}
library(tidyr)
library(dplyr)
library(stringr)
library(DescTools)
library(ggplot2)
```

## Data cleaning

Cleaning data: - replace unknown data by NA, clean it - separate age and gender - extract clean (w/o ID) bacteria name - unified each name of bacteria and states of resistance

```{r}

dataset_readed <- read.csv("Bacteria_dataset_Multiresictance.csv")

dataset_readed[dataset_readed == "?"] <- NA
dataset_readed[dataset_readed == "missing"] <- NA
dataset_readed[dataset_readed == "unknown"] <- NA
dataset_readed[dataset_readed == "error"] <- NA
dataset_readed[dataset_readed == "???"] <- NA
dataset_readed[dataset_readed == "??"] <- NA
dataset_readed[dataset_readed == ""] <- NA
dataset_readed[dataset_readed == "None"] <- NA
dataset_readed[dataset_readed == "null"] <- NA
dataset_readed <- dataset_readed %>% 
  separate(Souches, into = c("Strain_ID", "souche_description"), 
           sep = " ", extra = "merge", fill = "right")
dataset_readed$souche_description <- tolower(dataset_readed$souche_description)
dataset_readed$souche_description <- trimws(dataset_readed$souche_description)

# Escherichia coli
dataset_readed$souche_description[dataset_readed$souche_description == "e.coi" 
                                  | dataset_readed$souche_description == "e coli" 
                                  | dataset_readed$souche_description == "e.cli" 
                                  | dataset_readed$souche_description == 
                                    "e. coli"] <- "escherichia coli"

# Enterobacteria spp.
dataset_readed$souche_description[dataset_readed$souche_description == 
                                    "spp. enteobacteria spp."] <- "enterobacteria spp."
dataset_readed$souche_description[dataset_readed$souche_description == 
                                    "enter.bacteria" 
                                  | dataset_readed$souche_description == "enteobacteria spp." 
                                  | dataset_readed$souche_description == 
                                    "enter.bacteria spp."] <- "enterobacteria spp."

# Klebsiella pneumoniae
dataset_readed$souche_description[dataset_readed$souche_description == "klbsiella pneumoniae" 
                                  |dataset_readed$souche_description == 
                                    "klebsie.lla pneumoniae"] <- "klebsiella pneumoniae"

# Proteus mirabilis
dataset_readed$souche_description[dataset_readed$souche_description == "protus mirabilis" 
                                  | dataset_readed$souche_description == "prot.eus mirabilis" 
                                  | dataset_readed$souche_description == 
                                    "proeus mirabilis"] <- "proteus mirabilis"

antibiotics <- c("AMX.AMP", "AMC", "CZ", "FOX", "CTX.CRO", "IPM", "GEN", "AN", 
                 "Acide.nalidixique", "ofx", "CIP", "C", 
                 "Co.trimoxazole", "Furanes", "colistine")

dataset_readed <- na.omit(dataset_readed)

dataset_readed[antibiotics] <- lapply(dataset_readed[antibiotics], function(x) {
  x[x == "r"] <- "R"
  x[x == "intermediate"] <- "R"
  x[x == "Intermediate"] <- "R"
  x[x == "i"] <- "R"
  x[x == "s"] <- "S"
  x
})

dataset_readed <- dataset_readed %>%
  separate(`age.gender`, into = c("age", "gender"), sep = "/", remove = FALSE)
```

After cleaning our data 8281 records remain.

## Descriptive analysis

### Initial descriptive analysis of ages and infection frequency

```{r}
dataset_readed$age <- as.numeric(dataset_readed$age)

cat("Descriptive analysis of ages\n")
summary(dataset_readed$age)
Mode(dataset_readed$age)
Kurt(dataset_readed$age)
Skew(dataset_readed$age)
```

We can observe that in our data there is wide spread of age groups (from infants to elderly persons). The mode age is 50 (that contains 167 times). Therefore, the age is not heavily skewed toward young people.

As the skewness is close to 0 so age distribution is almost symmetrical so we have nearly equal number of younger and older patients.

Kurtosis is negative (Platykurtic) so the distribution has thick tails.

### Frequencies of unique bacteria souches

We have 9 different types of bacteria.

```{r}
n_distinct(dataset_readed$souche_description)
```

There are frequencies of each bacteria we have so in the further part we will base our test only on the most frequent types:

```{r}
dataset_readed %>%
  count(souche_description, sort = TRUE) %>%
  ggplot(aes(x = reorder(souche_description, n), y = n)) +
  geom_col() +
  coord_flip() +
  labs(title = "Frequency of Bacteria Species",
    x = "Bacteria",
    y = "Amount") + theme_minimal()
```

### Distribution of total age

As analysed before, we can observe that out distribution is quite symmetrical and platykurtic, indeed. For our further ideas on influence of diabetes it would be crucial to know that age distribution of groups of patients that have either resistant or susceptible infection. As diabetes is more common among elderly people, if one our groups would have more elder people we wouldn't be able to make conclusions on dependence between these two metrics (diabetes and resistance).

```{r}
age <- dataset_readed$age
hist(age,breaks = seq(min(age,na.rm = TRUE), max(age, na.rm = TRUE), by = 2), 
     col = "skyblue",
     border = "white",
     main = "Distribution of patient ages",
     xlab = "Age",
     ylab = "Number of patients")

```

### Distributions of age by two groups: resistant, susceptible

We divided patients into 2 groups: resistant (when patient is resistant to \> 5 types of antibiotics) and susceptible otherwise

```{r}
abx_data <- dataset_readed[, antibiotics]
dataset_readed$R_count <- rowSums(abx_data == "R", na.rm = TRUE)
dataset_readed$Resistance_Status <- ifelse(dataset_readed$R_count > 5, 'Resistant', 'Susceptible')
group_r <- dataset_readed$age[dataset_readed$Resistance_Status == 'Resistant']
group_s <- dataset_readed$age[dataset_readed$Resistance_Status == 'Susceptible']
```

```{r}
par(mfrow = c(1, 2))
hist(group_r,
     col = "pink",
     border = 'magenta',
     main = "Ages with resistant infection",
     xlab = "Age",
     ylab = "Number of patients")

hist(group_s,
     col = "cyan",
     border = "blue",
     main = "Ages with susceptible infection",
     xlab = "Age",
     ylab = "Number of patients")
par(mfrow = c(1, 1))
```

### Central tendencies of age by two groups: resistant, susceptible

```{r}
# 2. Create the Visualization using your dataframe 'dataset_readed'
ggplot(dataset_readed, aes(x = Resistance_Status, y = age, fill = Resistance_Status)) +
  geom_violin(trim = FALSE, alpha = 0.7) +
  geom_boxplot(width = 0.1, fill = "white", outlier.shape = NA) +
  theme_minimal()
```

From this violin plot we can assume that age distributions of susceptible and resistant groups are similar so we will test this assumption using Kolmogorov-Smirnov test.

### Diabetes vs. Resistance Bar Chart

```{r}
ggplot(dataset_readed, aes(x = Diabetes, fill = Resistance_Status)) +
  geom_bar(position = "fill", width = 0.6) +
  
  scale_y_continuous(labels = scales::percent) +
  
  scale_fill_manual(values = c("Susceptible" = "lightgreen", "Resistant" = "orange")) +
  
  labs(title = "Impact of Diabetes on Antibiotic Resistance",
       subtitle = "Proportion of Resistant Infections by Diabetes Status",
       x = "Diabetes Status",
       y = "Percentage",
       fill = "Infection Status") +
  
  theme_minimal()
```

From this plot we observe that the proportion of people with resistant and susceptible infection almost equal among diabetes so we are going to test it and dive deeper into dependences for some types of bacteria.

### Heatmap of diabetes impact on resistance on different souches

```{r}
heatmap_data <- dataset_readed %>%
  group_by(souche_description, Diabetes) %>%
  summarise(
    Total_Cases = n(),
    Resistant_Count = sum(Resistance_Status == "Resistant"),
    Pct_Resistant = Resistant_Count / Total_Cases,
    .groups = "drop"
  )

ggplot(heatmap_data, aes(x = Diabetes, y = souche_description, fill = Pct_Resistant)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(Pct_Resistant, accuracy = 1)), color = "black", size = 3) +
  scale_fill_gradient(low = "#fff7bc", high = "#d95f0e", labels = scales::percent) +
  labs(
    title = "Antibiotic Resistance Heatmap",
    subtitle = "Percentage of Resistant Cases by Bacteria and Diabetes Status",
    x = "Diabetes Status",
    y = "Bacteria Type (Souche)",
    fill = "Resistance %"
  ) +
  theme_minimal() + 
  theme(
    panel.grid = element_blank()
  )
```

From this heat map we can observe that most types of bacteria have the same resistance level not depending on diabetes status. But we also should test it to get more precise result.

# Hypotheses testing

To start with, as one of our hypotheses is based on age metric, it is natural to test the similarity of resistant and susceptible age group distributions.

## Age tendencies

First we will compare overall distributions of groups using Kolmogorov-Smirnov test
$H_0$: resistant and susceptible groups have the same distribution 
$H_1$: resistant and susceptible groups have not the same distribution

```{r}
ks.test(jitter(group_r), jitter(group_s))
```

```{r}
plot(ecdf(group_s), col="cyan", main="ECDFs comparison")
s_range <- seq(min(group_s), max(group_s), length.out = 500)
lines(s_range, 
      ecdf(group_r)(s_range), 
      col = "magenta", 
      lwd = 2)
```

Difference between distribution of resistant group and susceptible are pretty small, p-value 0,4808 is greater than 0,05 so we fail to reject $H_0$ Therefore the distributions of resistant and susceptible groups are equal. Kolmogorov-Smirnov test for whether distributions of two groups of patients are equal. -\> **Not Rejected**

Therefore, we can conclude that the age does not influence the resistance of bacterial infection.

## Diabetes impact on resistance

As we have some info on risk factors in our dataset, we decided to test whether some of them influence the resistance.

Our aim here was firstly to test whether there is connection between having diabetes and more resistant infection at all. And then we can further test if the type of bacteria has an impact on that connection, meaning impact of diabetes on resistance depends on type of infection for which we test the resistance. Therefore, we are performing the following:

1.  Construct a contingency table for Chi-squared test for independence

2.  Perform Chi-Squared test for independence (of diabetes and resistance factor)

Though by itself, long term diseases like diabetes or hypertension do not directly influence resistance of bacterial infections to antibiotics, they do influence the frequency of illness, which then influences antibiotic consumption and that influences bacterial adaptability (which is extremely fast) and poses a resistance.

$H_0$: people who have diabetes are not more prone to have resistance to antibiotics
$H_1$: people who have diabetes are more prone to have resistance to antibiotics

```{r}

diabetic_r <- dataset_readed$ID[dataset_readed$Resistance_Status == 
                                  'Resistant'& dataset_readed$Diabetes == "True" ]
diabetic_s <- dataset_readed$ID[dataset_readed$Resistance_Status == 
                                  'Susceptible' & dataset_readed$Diabetes == "True" ]

nondiabetic_r <- dataset_readed$ID[dataset_readed$Resistance_Status == 
                                     'Resistant'& dataset_readed$Diabetes == "No" ]
nondiabetic_s <-  dataset_readed$ID[dataset_readed$Resistance_Status == 
                                      'Susceptible'& dataset_readed$Diabetes == "No" ]
```

```{r}

contingency_table <- table(dataset_readed$Diabetes, dataset_readed$Resistance_Status)

contingency_table_marings <- addmargins(contingency_table)

print(contingency_table_marings)
```

```{r}
chisq.test(contingency_table)
```

Here we can see, that using Chi-Squared Test for independence the diabetes seems to have no statistically significant impact on resistance of bacterial infection But now we will dive deeper. Continue to the previous, we want to check if diabetes influence depends on bacteria type. We will focus on top3 bacteria infections from dataset, as they have the most datapoints, and may pose some influence of diabetes on the resistance $H_0$: the effect of diabetes on resistance does not depend on the type of bacteria $H_1$: the effect of diabetes on resistance does depend on the type of bacteria

### Diabetes impact depending on type of bacteria 

We are now going to construct strata tables for top 3 most frequent bacteria types (**Escherichia coli, Enterobacteria spp., Proteus Mirabilis**) and check if there are impacts of diabetes in these strata.

We see that in fact, using Breslow-Day test, diabetes influence does depend on bacteria type, as the p-value is smal and we reject null hypothesis of equals Odds Ratios (look into conclusions for more detailed explanation)! We can further investigate our discrepnacy with initial heatmap from data visualizations and the outcome of this test

Therefore we used Breslow-Day Test on Homogeneity of Odds Ratios

1.  We first construct three tables for each strata(type of bacteria). The table is similar to the one previous test (diabetes/resistance)

2.  For each strata we calculate Odds Ratio (OR)

    |              | Resistant | Susceptible |
    |--------------|-----------|-------------|
    | Diabetic     | a         | b           |
    | Non-Diabetic | c         | d           |

    $$
    OR = \dfrac{a}{c}\cdot\dfrac{d}{b}
    $$

So if the ratio of diabetic and non diabetic having resistance is the same as those of susceptible, then OR should be close to 1.

In order to check if the type of bacteria doesn't influence the diabetes factor on resistance, we should compare OR of all strata (3 types of bacteria)

$H_0: \quad OR_1 = OR_2 = OR_3$ , bacteria type does not affect diabetes factor on resistance

$H_1: \quad OR_1\ne OR_2 \ne OR_3$ , bacteria type does affect diabetes factor on resistance

3.  Then the test uses chi-squared statistic (expected/observed values) to test these hypotheses. -\> **Rejected**

```{r}
top3_bacteria <- c("escherichia coli", "enterobacteria spp.", "proteus mirabilis")
data_top3 <- dataset_readed[dataset_readed$souche_description 
                            %in% top3_bacteria & !is.na(dataset_readed$Diabetes), ]

table_3way <- table(data_top3$Diabetes, data_top3$Resistance_Status, data_top3$souche_description)
table_3way_safe <- array(as.numeric(table_3way), 
                         dim = dim(table_3way), 
                         dimnames = dimnames(table_3way))
#Breslow-Day test (tests for homogeneity of odds ratios across strata)
BreslowDayTest(table_3way_safe)
```

**So the effect of diabetes on resistance in fact appears and does depend on bacteria type.** But as we remember from our heat map we observed that there should not be any dependence. To be more rigorous, let us check odds ratios of stratas and see if they diverge from 1 and are different among themselves.

```{r}
#calculating odds ratios
or_check <- dataset_readed %>%
  group_by(souche_description) %>%
  summarise(

    A = sum(Diabetes == "True" & Resistance_Status == "Resistant"),
    B = sum(Diabetes == "True" & Resistance_Status == "Susceptible"),
    C = sum(Diabetes == "No" & Resistance_Status == "Resistant"),
    D = sum(Diabetes == "No" & Resistance_Status == "Susceptible"),
    
    #adding +0.5 to avoid division by zero (Haldane correction)
    Odds_Ratio = ((A + 0.5) * (D + 0.5)) / ((B + 0.5) * (C + 0.5)),
    
    #check sample size to see if heatmap was misleading
    Total_Patients = n()
  )

print(or_check)
```

We see that in fact there are odds ratios that are far from 1 and differ. So the heat map, although being a nice visual, does not represent a relation that is indeed present.

## Conclusions

Our project was mainly aimed for discovering patterns in antibiotic resistance, approving theoretical knowledge from P&S course and biology with practical applications of testing hypothesis. It is known that diabetes has an impact on immune system but we wanted to prove whether this impact influences antibiotic resistance. First of all, diabetes in itself does not directly raise resistance of infection.Though, we wanted to observe the indirect influence describing by such sequence of events

**Diabetes** -\> Weaker immune system -\> More frequent illnesses -\> Consistent consumption of antibiotics -\> Bacteria adaptation to antibiotics -\> **Produced resistance**

In order to test it we needed to have an equal distributions of resistant and susceptible age groups so that if observed we can conclude that dependence is not biased (as the elderly people have more frequent diabetes occurence). Indeed, the distributions was equal.

Hence, we discovered, using test for independence, that diabetes does not raise resistance on the whole data. But then, splitting the data groups into top 3 infections, the impact occurred.

Revising the work done so far, we inferred insightful knowledge about outcomes of our results: Simpsons' paradox. That is a phenomenon in probability and statistics where a trend or relationship that appears in several different groups of data disappears or even reverses when the groups are combined. In our specific example, the paradox means that while our overall test on all bacteria groups showed no dependence between diabetes and bacterial resistance, the relationship emerged when we analyzed the top 3 groups of bacteria separately.

To sum up, in this mini-research project we have worked with practical dataset from clinical research. We have examined key metrics (age) and risk factors (diabetes). We have successfully checked resistance patterns. Precisely, there is no pattern regarding age of patients, however, there is a great pattern in having diabetes and specific type of infection that through all data asserts resistance to that infection. In future, to continue our research, possible consequent areas for improvement could be building a logistic regression on classifying bacterial infection (resistant/susceptible), examining dependence of resistance to specific geographical area (South, East, West, North).
